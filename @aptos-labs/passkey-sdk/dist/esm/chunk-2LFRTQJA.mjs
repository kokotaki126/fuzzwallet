import{a as Tn,b as wn,c as Pn}from"./chunk-UAHVITSF.mjs";import{q as $,t as q}from"./chunk-RNO5ZG3C.mjs";import{a as cn}from"./chunk-O57QZZF2.mjs";import{a as m}from"./chunk-YAFCDFY6.mjs";import{a as S,c as T,d as w}from"./chunk-YVSIS6BA.mjs";import{c as gn,d as dn,e as An,f as yn,g as mn,h as fn,i as ln}from"./chunk-VO2CATMP.mjs";import{a as pn}from"./chunk-QKTV6AZ7.mjs";import{b as O,d as k,e as v,f as W}from"./chunk-Z7L4BWPD.mjs";import{b as h,d as y,e as un}from"./chunk-LU26SB5N.mjs";import{a as x}from"./chunk-YSI4WO4O.mjs";import{a as an}from"./chunk-YOKWQQVO.mjs";import{a as P}from"./chunk-PYNE2KAA.mjs";import{a as f}from"./chunk-FOY4V3ID.mjs";import{c as F}from"./chunk-JL2RLTCL.mjs";import{a as tn,c as en}from"./chunk-I7WRJY7K.mjs";import{a as K,c as N}from"./chunk-OG333K5S.mjs";import{a as b,c as R}from"./chunk-ZFIMVSCR.mjs";import{b as u}from"./chunk-F7CR75CJ.mjs";import{b as sn}from"./chunk-T7U4YWE7.mjs";import{a as rn}from"./chunk-AH44UPM4.mjs";import{a as A}from"./chunk-F7MOQC7Z.mjs";import{b as G}from"./chunk-VRSUCKJA.mjs";import{b as M}from"./chunk-NL72WE3E.mjs";import{a as on}from"./chunk-QN3TJQIU.mjs";import{b as E}from"./chunk-YE3DZD6T.mjs";import{c as Q,d as Y,g as nn,h as U}from"./chunk-HHJBCGAQ.mjs";import{e as B}from"./chunk-77SKA4HT.mjs";import{sha3_256 as xn}from"@noble/hashes/sha3";import{isoBase64URL as z}from"@simplewebauthn/server/helpers";import{p256 as Kn}from"@noble/curves/p256";import{base64URLStringToBuffer as Nn,startAuthentication as Fn}from"@simplewebauthn/browser";import{generateAuthenticationOptions as On}from"@simplewebauthn/server";async function bn(n){let e=await Dn(n);return _n(n,e)}async function Dn(n){let{aptosConfig:e,data:t}=n,a,o;return"bytecode"in t?(a=t,o=await C(a)):"multisigAddress"in t?(a={aptosConfig:e,multisigAddress:t.multisigAddress,function:t.function,functionArguments:t.functionArguments,typeArguments:t.typeArguments},o=await C(a)):(a={aptosConfig:e,function:t.function,functionArguments:t.functionArguments,typeArguments:t.typeArguments},o=await C(a)),o}async function _n(n,e){let{aptosConfig:t,sender:a,options:o}=n,r;if(Bn(n)&&(r=u.ZERO.toString()),Un(n)){let{secondarySignerAddresses:i}=n;return H({aptosConfig:t,sender:a,payload:e,options:o,secondarySignerAddresses:i,feePayerAddress:r})}return H({aptosConfig:t,sender:a,payload:e,options:o,feePayerAddress:r})}function Bn(n){return n.withFeePayer===!0}function Un(n){return"secondarySignerAddresses"in n}function Rn(n){let{transaction:e}=n;return L(e)}function En(n){return Sn({...n})}async function et(n){let{aptosConfig:e,transaction:t,signerPublicKey:a,secondarySignersPublicKeys:o,feePayerPublicKey:r,options:i}=n,c=hn({transaction:t,signerPublicKey:a,secondarySignersPublicKeys:o,feePayerPublicKey:r,options:i}),{data:s}=await E({aptosConfig:e,body:c,path:"transactions/simulate",params:{estimate_gas_unit_price:n.options?.estimateGasUnitPrice??!1,estimate_max_gas_amount:n.options?.estimateMaxGasAmount??!1,estimate_prioritized_gas_unit_price:n.options?.estimatePrioritizedGasUnitPrice??!1},originMethod:"simulateTransaction",contentType:"application/x.aptos.signed_transaction+bcs"});return s}async function Mn(n){let{aptosConfig:e}=n,t=In({...n}),{data:a}=await E({aptosConfig:e,body:t,path:"transactions",originMethod:"submitTransaction",contentType:"application/x.aptos.signed_transaction+bcs"});return a}async function Gn(n){let{aptosConfig:e,signer:t,transaction:a}=n,o=En({signer:t,transaction:a});return Mn({aptosConfig:e,transaction:a,senderAuthenticator:o})}async function at(n){let{aptosConfig:e,account:t,metadataBytes:a,moduleBytecode:o,options:r}=n,i=o.map(s=>A.U8(s));return await bn({aptosConfig:e,sender:u.from(t),data:{function:"0x1::code::publish_package_txn",functionArguments:[A.U8(a),new A(i)]},options:r})}async function ot(n){let{aptosConfig:e,fromAccount:t,toNewPrivateKey:a}=n,o=await x({aptosConfig:e,accountAddress:t.accountAddress}),r=an.fromPrivateKey({privateKey:a,legacy:!0}),c=new cn({sequenceNumber:BigInt(o.sequence_number),originator:t.accountAddress,currentAuthKey:u.from(o.authentication_key),newPublicKey:r.publicKey}).bcsToBytes(),s=t.sign(c),p=r.sign(c),g=await bn({aptosConfig:e,sender:t.accountAddress,data:{function:"0x1::account::rotate_authentication_key",functionArguments:[new G(t.signingScheme.valueOf()),A.U8(t.publicKey.toUint8Array()),new G(r.signingScheme.valueOf()),A.U8(r.publicKey.toUint8Array()),A.U8(s.toUint8Array()),A.U8(p.toUint8Array())]}});return await Gn({aptosConfig:e,signer:t,transaction:g})}async function C(n){if($(n))return Cn(n);let{moduleAddress:e,moduleName:t,functionName:a}=q(n.function),o=await rn(async()=>wn(e,t,a,n.aptosConfig),`entry-function-${n.aptosConfig.network}-${e}-${t}-${a}`,1e3*60*5)();return kn(n,o)}function kn(n,e){if($(n))return Cn(n);let{moduleAddress:t,moduleName:a,functionName:o}=q(n.function),r=Tn(n.typeArguments);if(r.length!==e.typeParameters.length)throw new Error(`Type argument count mismatch, expected ${e.typeParameters.length}, received ${r.length}`);let i=n.functionArguments.map((s,p)=>Pn(n.function,e,s,p,r));if(i.length!==e.parameters.length)throw new Error(`Too few arguments for '${t}::${a}::${o}', expected ${e.parameters.length} but got ${i.length}`);let c=yn.build(`${t}::${a}`,o,r,i);if("multisigAddress"in n){let s=u.from(n.multisigAddress);return new An(new fn(s,new ln(c)))}return new dn(c)}function Cn(n){return new gn(new mn(M.fromHexInput(n.bytecode).toUint8Array(),n.typeArguments??[],n.functionArguments))}async function vn(n){let{aptosConfig:e,sender:t,payload:a,options:o,feePayerAddress:r}=n,i=B[e.network]?Promise.resolve({chain_id:B[e.network]}):on({aptosConfig:e}),c=o?.gasUnitPrice?Promise.resolve({gas_estimate:o.gasUnitPrice}):sn({aptosConfig:e}),[{chain_id:s},{gas_estimate:p}]=await Promise.all([i,c]),g=o?.accountSequenceNumber!==void 0?Promise.resolve({sequence_number:o.accountSequenceNumber}):x({aptosConfig:e,accountAddress:t}),d;if(r&&u.from(r).equals(u.ZERO))try{let{sequence_number:l}=await g;d=l}catch{d="0"}else{let{sequence_number:l}=await g;d=l}let{maxGasAmount:X,gasUnitPrice:I,expireTimestamp:_}={maxGasAmount:o?.maxGasAmount?BigInt(o.maxGasAmount):BigInt(Q),gasUnitPrice:BigInt(p),expireTimestamp:BigInt(Math.floor(Date.now()/1e3)+Y),...o};return new S(u.from(t),BigInt(d),a,BigInt(X),BigInt(I),BigInt(_),new pn(s))}async function H(n){let{aptosConfig:e,sender:t,payload:a,options:o,feePayerAddress:r}=n,i=await vn({aptosConfig:e,sender:t,payload:a,options:o,feePayerAddress:r});if("secondarySignerAddresses"in n){let c=n.secondarySignerAddresses?.map(s=>u.from(s))??[];return{rawTransaction:i,secondarySignerAddresses:c,feePayerAddress:n.feePayerAddress?u.from(n.feePayerAddress):void 0}}return{rawTransaction:i,feePayerAddress:n.feePayerAddress?u.from(n.feePayerAddress):void 0}}function hn(n){let{signerPublicKey:e,transaction:t,secondarySignersPublicKeys:a,feePayerPublicKey:o}=n,r=D(e);if(t.feePayerAddress){let c=new w(t.rawTransaction,t.secondarySignerAddresses??[],t.feePayerAddress),s=[];a&&(s=a.map(d=>D(d)));let p=D(o),g=new v(r,t.secondarySignerAddresses??[],s,{address:t.feePayerAddress,authenticator:p});return new m(c.raw_txn,g).bcsToBytes()}if(t.secondarySignerAddresses){let c=new T(t.rawTransaction,t.secondarySignerAddresses),s=[];s=a.map(g=>D(g));let p=new k(r,t.secondarySignerAddresses,s);return new m(c.raw_txn,p).bcsToBytes()}let i;if(r instanceof h)i=new O(r.public_key,r.signature);else if(r instanceof y)i=new W(r);else throw new Error("Invalid public key");return new m(t.rawTransaction,i).bcsToBytes()}function D(n){if(n instanceof P){if(n.publicKey instanceof b)return new y(n,new f(new R(new Uint8Array(64))));if(n.publicKey instanceof tn)return new y(n,new f(new en(new Uint8Array(64))))}return new h(new b(n.toUint8Array()),new R(new Uint8Array(64)))}function Sn(n){let{signer:e,transaction:t}=n,a=L(t),o=e.sign(a);switch(e.signingScheme){case 0:return new h(new b(e.publicKey.toUint8Array()),new R(o.toUint8Array()));case 2:if(!P.isPublicKey(e.publicKey))throw new Error(`Cannot sign transaction, public key does not match ${e.signingScheme}`);return new y(e.publicKey,new f(o));default:throw new Error(`Cannot sign transaction, signing scheme ${e.signingScheme} not supported`)}}async function Ot(n){let{credentialId:e,publicKey:t,transaction:a,timeout:o,rpID:r,options:i}=n;if(console.log("PublicKey",t.toString()),!(t instanceof K))throw new Error("Unsupported public key for passkey signing.");let c=i?.allowCredentials??[{type:"public-key",id:typeof e=="string"?z.toBuffer(e):e}],s={rawTransaction:J(a)},p=Rn({transaction:s}),g=xn(p),d=await On({allowCredentials:c,challenge:g,timeout:o,rpID:r,userVerification:"required"}),I=(await Fn(d)).response;console.log(I);let{clientDataJSON:_,authenticatorData:l,signature:V}=I;console.log("DER Signature: ",V);let Z=Kn.Signature.fromDER(new Uint8Array(Nn(V))).toCompactRawBytes();console.log("COMPACT Signature: ",new M(Z).toString());let j=new F(new N(Z),z.toBuffer(l),z.toBuffer(_));return console.log("WEBAUTHN Signature: ",j),new y(new P(t),new f(j))}function kt(n){let{publicKey:e,signature:t,authenticatorData:a,clientDataJSON:o}=n,r;if(e instanceof K)r=new f(new N(t));else throw new Error("Unsupported public key");let i=new F(r,a,o);return new y(new P(e),new f(i))}function In(n){let{transaction:e,senderAuthenticator:t,feePayerAuthenticator:a,additionalSignersAuthenticators:o}=n,r=J(e);if((a||o)&&(r instanceof T||r instanceof w))return Wn(r,t,a,o);if(t instanceof h&&r instanceof S){let i=new O(t.public_key,t.signature);return new m(r,i).bcsToBytes()}if((t instanceof y||t instanceof un)&&r instanceof S){let i=new W(t);return new m(r,i).bcsToBytes()}throw new Error(`Cannot generate a signed transaction, ${t} is not a supported account authentication scheme`)}function J(n){return n.feePayerAddress?new w(n.rawTransaction,n.secondarySignerAddresses??[],n.feePayerAddress):n.secondarySignerAddresses?new T(n.rawTransaction,n.secondarySignerAddresses):n.rawTransaction}function Wn(n,e,t,a){if(n instanceof w){if(!t)throw new Error("Must provide a feePayerAuthenticator argument to generate a signed fee payer transaction");let o=new v(e,n.secondary_signer_addresses,a??[],{address:n.fee_payer_address,authenticator:t});return new m(n.raw_txn,o).bcsToBytes()}if(n instanceof T){if(!a)throw new Error("Must provide a additionalSignersAuthenticators argument to generate a signed multi agent transaction");let o=new k(e,n.secondary_signer_addresses,a??[]);return new m(n.raw_txn,o).bcsToBytes()}throw new Error(`Cannot prepare multi signers transaction to submission, ${typeof n} transaction is not supported`)}function L(n){let e=J(n),t=xn.create();if(e instanceof S)t.update(nn);else if(e instanceof T)t.update(U);else if(e instanceof w)t.update(U);else throw new Error(`Unknown transaction type to sign on: ${e}`);let a=t.digest(),o=e.bcsToBytes(),r=new Uint8Array(a.length+o.length);return r.set(a),r.set(o,a.length),r}export{C as a,kn as b,vn as c,H as d,hn as e,D as f,Sn as g,Ot as h,kt as i,In as j,J as k,Wn as l,L as m,bn as n,Dn as o,_n as p,Rn as q,En as r,et as s,Mn as t,Gn as u,at as v,ot as w};
//# sourceMappingURL=chunk-2LFRTQJA.mjs.map